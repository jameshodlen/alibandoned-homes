name: Test Suite

# =============================================================================
# GITHUB ACTIONS CI/CD
# =============================================================================
#
# Continuous Integration (CI):
# - Automatically run tests on every push/PR
# - Catch bugs before they reach main branch
# - Ensure code quality standards
#
# Configuration:
# - on: Triggers (push, pull_request, schedule)
# - jobs: Tasks to run
# - steps: Individual actions within a job
# =============================================================================

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # Also run on schedule (daily at midnight UTC)
  schedule:
    - cron: '0 0 * * *'

jobs:
  # ===========================================================================
  # BACKEND TESTS
  # ===========================================================================
  backend-tests:
    runs-on: ubuntu-latest
    
    # Service containers (databases, caches)
    services:
      postgres:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    # Environment variables for tests
    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/test_db
      API_KEY: test-api-key-ci
      TESTING: "1"
    
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache pip dependencies
      
      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx
      
      # Run linting (optional but recommended)
      - name: Lint with ruff
        run: |
          pip install ruff
          ruff check backend/ --ignore=E501
        continue-on-error: true  # Don't fail on lint errors (for now)
      
      # Run unit tests
      - name: Run unit tests
        run: |
          cd backend
          pytest tests/ -m "not slow and not integration" --cov=. --cov-report=xml -v
      
      # Run integration tests
      - name: Run integration tests
        run: |
          cd backend
          pytest tests/ -m "integration" --cov=. --cov-report=xml --cov-append -v
      
      # Upload coverage to Codecov
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # FRONTEND TESTS
  # ===========================================================================
  frontend-tests:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint --if-present
        continue-on-error: true
      
      # Run Jest tests
      - name: Run unit tests
        run: npm test -- --coverage --watchAll=false
      
      # Build check
      - name: Build
        run: npm run build

  # ===========================================================================
  # E2E TESTS
  # ===========================================================================
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]  # Run after unit tests pass
    
    services:
      postgres:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Setup backend
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install backend dependencies
        run: |
          pip install -r backend/requirements.txt
      
      - name: Start backend server
        run: |
          cd backend
          uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          sleep 5  # Wait for server to start
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          API_KEY: test-api-key
      
      # Setup frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      # Run Cypress E2E tests
      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: frontend
          start: npm run preview
          wait-on: 'http://localhost:4173'
          wait-on-timeout: 60
        env:
          REACT_APP_API_URL: http://localhost:8000
      
      # Upload Cypress screenshots/videos on failure
      - name: Upload Cypress artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-artifacts
          path: |
            frontend/cypress/screenshots
            frontend/cypress/videos

  # ===========================================================================
  # SECURITY SCANNING
  # ===========================================================================
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Python security scan
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run safety check
        run: |
          pip install safety
          safety check -r backend/requirements.txt || true
      
      - name: Run bandit security linter
        run: |
          pip install bandit
          bandit -r backend/ -ll || true
      
      # Node security scan
      - name: NPM audit
        run: |
          cd frontend
          npm audit --audit-level=high || true


# =============================================================================
# CI/CD BEST PRACTICES
# =============================================================================
#
# 1. FAST FEEDBACK
#    - Run fast tests first
#    - Parallelize when possible
#    - Cache dependencies
#
# 2. FAIL FAST
#    - Stop on first failure (optional)
#    - Clear error messages
#
# 3. REPRODUCIBILITY
#    - Pin versions
#    - Use lock files (package-lock.json, poetry.lock)
#
# 4. SECURITY
#    - Don't commit secrets
#    - Use GitHub Secrets for sensitive data
#    - Scan for vulnerabilities
#
# 5. CODE COVERAGE
#    - Track over time
#    - Set minimum thresholds
#    - Focus on critical code
# =============================================================================
