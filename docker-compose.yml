version: '3.8'

# Comment: "Docker Compose orchestrates multiple containers"

services:
  # PostgreSQL with PostGIS
  db:
    image: postgis/postgis:15-3.3
    # Comment: "Official PostGIS image includes PostgreSQL + spatial extensions"

    container_name: abandoned-homes-db

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-abandoned_homes}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # Comment: "Use .env file for secrets, never commit passwords!"

    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Comment: "Named volume persists data across container restarts"
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
      # Comment: "Initialization script runs on first start"

    ports:
      - "5432:5432"

    networks:
      - app-network

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5

    restart: unless-stopped
    # Comment: "Restart policy: always restart unless manually stopped"

    # Redis (caching)
  redis:
    image: redis:7-alpine
    container_name: abandoned-homes-redis

    ports:
      - "6379:6379"

    volumes:
      - redis_data:/data

    networks:
      - app-network

    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

    restart: unless-stopped

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile

    container_name: abandoned-homes-backend

    environment:
      # Connect using service name 'db'
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      REDIS_URL: redis://redis:6379/0
      API_KEY: ${API_KEY}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      # Comment: "Environment variables configure the app"

    volumes:
      - ./models:/app/models
      # Comment: "Mount models directory for persistence"
      - ./storage:/app/storage
      # Comment: "Mount storage for photos"
      - ./logs:/app/logs

    ports:
      - "8000:8000"

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    # Comment: "Wait for DB and Redis to be ready before starting"

    networks:
      - app-network

    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile

    container_name: abandoned-homes-frontend

    environment:
      # Nginx config proxies /api to backend, so we don't need this at runtime usually
      # but React app build might need it if baked in (CRA behavior)
      REACT_APP_API_URL: http://localhost:8000
      REACT_APP_API_KEY: ${API_KEY}

    ports:
      - "3000:80"

    depends_on:
      - backend

    networks:
      - app-network

    restart: unless-stopped

# Named volumes for data persistence
volumes:
  postgres_data: # Comment: "Docker manages this volume, survives container deletion"
  redis_data:

    # Custom network for container communication
networks:
  app-network:
    driver: bridge
    # Comment: "Containers on same network can communicate by service name"
